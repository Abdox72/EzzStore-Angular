<div class="admin-orders">
  <div class="header">
    <h1>إدارة الطلبات</h1>
    <p>إدارة جميع الطلبات وتحديث حالاتها</p>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-grid">
      <div class="filter-group">
        <label for="statusFilter">حالة الطلب:</label>
        <select id="statusFilter" [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
          <option value="">جميع الحالات</option>
          <option *ngFor="let status of orderStatuses" [value]="status.value">
            {{ status.label }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label for="paymentStatusFilter">حالة الدفع:</label>
        <select id="paymentStatusFilter" [(ngModel)]="paymentStatusFilter" (change)="onPaymentStatusFilterChange()">
          <option value="">جميع حالات الدفع</option>
          <option *ngFor="let status of paymentStatuses" [value]="status.value">
            {{ status.label }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label for="searchTerm">بحث:</label>
        <input 
          type="text" 
          id="searchTerm" 
          [(ngModel)]="searchTerm" 
          (input)="onSearchChange()"
          placeholder="اسم العميل، البريد الإلكتروني، أو رقم الطلب"
        >
      </div>
    </div>
  </div>

  <!-- Error Display -->
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>جاري التحميل...</p>
  </div>

  <!-- Orders Table -->
  <div class="orders-table" *ngIf="!loading">
    <table>
      <thead>
        <tr>
          <th>رقم الطلب</th>
          <th>العميل</th>
          <th>البريد الإلكتروني</th>
          <th>المبلغ</th>
          <th>طريقة الدفع</th>
          <th>حالة الدفع</th>
          <th>حالة الطلب</th>
          <th>التاريخ</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of filteredOrders" 
            [class.selected]="selectedOrder?.id === order.id"
            (click)="selectOrder(order)">
          <td>#{{ order.id }}</td>
          <td>{{ order.customerName }}</td>
          <td>{{ order.customerEmail }}</td>
          <td>{{ order.totalAmount | currency:'KWD' }}</td>
          <td>{{ getPaymentMethodText(order.paymentMethod) }}</td>
          <td>
            <span class="status-badge" [class]="getPaymentStatusClass(order.paymentStatus)">
              {{ getPaymentStatusText(order.paymentStatus) }}
            </span>
          </td>
          <td>
            <span class="status-badge" [class]="getStatusClass(order.orderStatus)">
              {{ getStatusText(order.orderStatus) }}
            </span>
          </td>
          <td>{{ order.createdAt | date:'short' }}</td>
          <td>
            <button class="btn-select" (click)="selectOrder(order)">
              تحديد
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="filteredOrders.length === 0" class="no-orders">
      <p>لا توجد طلبات</p>
    </div>
  </div>

  <!-- Order Details Sidebar -->
  <div class="order-details" *ngIf="selectedOrder">
    <div class="sidebar-header">
      <h3>تفاصيل الطلب #{{ selectedOrder.id }}</h3>
      <button class="btn-close" (click)="clearSelection()">×</button>
    </div>

    <div class="order-info">
      <div class="info-section">
        <h4>معلومات العميل</h4>
        <p><strong>الاسم:</strong> {{ selectedOrder.customerName }}</p>
        <p><strong>البريد الإلكتروني:</strong> {{ selectedOrder.customerEmail }}</p>
        <p><strong>الهاتف:</strong> {{ selectedOrder.customerPhone }}</p>
        <p *ngIf="selectedOrder.customerAddress"><strong>العنوان:</strong> {{ selectedOrder.customerAddress }}</p>
        <p *ngIf="selectedOrder.customerCity"><strong>المدينة:</strong> {{ selectedOrder.customerCity }}</p>
        <p *ngIf="selectedOrder.customerPostalCode"><strong>الرمز البريدي:</strong> {{ selectedOrder.customerPostalCode }}</p>
      </div>

      <div class="info-section">
        <h4>تفاصيل الطلب</h4>
        <p><strong>المبلغ الإجمالي:</strong> {{ selectedOrder.totalAmount | currency:'KWD' }}</p>
        <p><strong>طريقة الدفع:</strong> {{ getPaymentMethodText(selectedOrder.paymentMethod) }}</p>
        <p><strong>حالة الدفع:</strong> {{ getPaymentStatusText(selectedOrder.paymentStatus) }}</p>
        <p><strong>حالة الطلب:</strong> {{ getStatusText(selectedOrder.orderStatus) }}</p>
        <p><strong>تاريخ الطلب:</strong> {{ selectedOrder.createdAt | date:'full' }}</p>
      </div>

      <div class="info-section" *ngIf="selectedOrder.trackingNumber">
        <h4>معلومات التتبع</h4>
        <p><strong>رقم التتبع:</strong> {{ selectedOrder.trackingNumber }}</p>
        <p><strong>شركة الشحن:</strong> {{ selectedOrder.carrier }}</p>
        <p *ngIf="selectedOrder.shippedAt"><strong>تاريخ الشحن:</strong> {{ selectedOrder.shippedAt | date:'full' }}</p>
      </div>

      <div class="info-section">
        <h4>المنتجات</h4>
        <div class="order-items">
          <div *ngFor="let item of selectedOrder.orderItems" class="order-item">
            <span class="item-name">{{ item.productName }}</span>
            <span class="item-quantity">×{{ item.quantity }}</span>
            <span class="item-price">{{ item.totalPrice | currency:'KWD' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Forms -->
    <div class="action-forms">
      <!-- Update Status Form -->
      <div class="form-section" *ngIf="canUpdateStatus(selectedOrder)">
        <h4>تحديث حالة الطلب</h4>
        <form [formGroup]="statusForm" (ngSubmit)="updateOrderStatus()">
          <div class="form-group">
            <label for="status">الحالة الجديدة:</label>
            <select id="status" formControlName="status">
              <option *ngFor="let status of orderStatuses" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
          </div>
          <button type="submit" class="btn-primary" [disabled]="!statusForm.valid || loading">
            تحديث الحالة
          </button>
        </form>
      </div>

      <!-- Payment Status Form -->
      <div class="form-section" *ngIf="canUpdatePaymentStatus(selectedOrder)">
        <h4>تحديث حالة الدفع</h4>
        <form [formGroup]="paymentStatusForm" (ngSubmit)="updatePaymentStatus()">
          <div class="form-group">
            <label for="paymentStatus">حالة الدفع الجديدة:</label>
            <select id="paymentStatus" formControlName="status">
              <option *ngFor="let status of paymentStatuses" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
          </div>
          <button type="submit" class="btn-primary" [disabled]="!paymentStatusForm.valid || loading">
            تحديث حالة الدفع
          </button>
        </form>
      </div>

      <!-- Tracking Form -->
      <div class="form-section" *ngIf="canAddTracking(selectedOrder)">
        <h4>إضافة/تحديث معلومات التتبع</h4>
        <form [formGroup]="trackingForm" (ngSubmit)="updateTrackingInfo()">
          <div class="form-group">
            <label for="trackingNumber">رقم التتبع:</label>
            <input type="text" id="trackingNumber" formControlName="trackingNumber">
          </div>
          <div class="form-group">
            <label for="carrier">شركة الشحن:</label>
            <input type="text" id="carrier" formControlName="carrier">
          </div>
          <button type="submit" class="btn-primary" [disabled]="!trackingForm.valid || loading">
            تحديث التتبع
          </button>
        </form>
      </div>

      <!-- Refund Form -->
      <div class="form-section" *ngIf="canRefund(selectedOrder)">
        <h4>استرداد الطلب</h4>
        <form [formGroup]="refundForm" (ngSubmit)="refundOrder()">
          <div class="form-group">
            <label for="reason">سبب الاسترداد:</label>
            <textarea id="reason" formControlName="reason" rows="3"></textarea>
          </div>
          <button type="submit" class="btn-danger" [disabled]="!refundForm.valid || loading">
            استرداد الطلب
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
