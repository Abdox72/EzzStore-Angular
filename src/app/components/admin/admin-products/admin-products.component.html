<div class="admin-products-container">
  <div class="header">
    <h1>إدارة المنتجات</h1>
    <p>إدارة جميع منتجات المتجر</p>
  </div>

  <!-- Advanced Filters Section -->
  <div class="filters-section">
    <div class="filters-grid">
      <!-- Basic Filters -->
      <div class="filter-group">
        <label for="searchTerm">البحث:</label>
        <input type="text" id="searchTerm" [(ngModel)]="searchTerm" 
               placeholder="اسم المنتج أو الوصف...">
      </div>

      <div class="filter-group">
        <label for="selectedCategory">الفئة:</label>
        <select id="selectedCategory" [(ngModel)]="selectedCategory">
          <option [value]="null">جميع الفئات</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label for="minPrice">الحد الأدنى للسعر:</label>
        <input type="number" id="minPrice" [(ngModel)]="minPrice" 
               placeholder="0" min="0" step="0.01">
      </div>

      <div class="filter-group">
        <label for="maxPrice">الحد الأقصى للسعر:</label>
        <input type="number" id="maxPrice" [(ngModel)]="maxPrice" 
               placeholder="1000" min="0" step="0.01">
      </div>
    </div>

    <div class="filters-grid">
      <div class="filter-group">
        <label for="minStock">الحد الأدنى للمخزون:</label>
        <input type="number" id="minStock" [(ngModel)]="minStock" 
               placeholder="0" min="0">
      </div>

      <div class="filter-group">
        <label for="maxStock">الحد الأقصى للمخزون:</label>
        <input type="number" id="maxStock" [(ngModel)]="maxStock" 
               placeholder="100" min="0">
      </div>

      <div class="filter-group">
        <label for="inStock">حالة المخزون:</label>
        <select id="inStock" [(ngModel)]="inStock">
          <option [value]="null">جميع المنتجات</option>
          <option [value]="true">متوفر</option>
          <option [value]="false">نفذ المخزون</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="pageSize">عدد العناصر في الصفحة:</label>
        <select id="pageSize" (change)="onPageSizeChange($event)">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>

    <div class="filter-actions">
      <button class="btn btn-primary" (click)="applyFilters()" [disabled]="loading">
        {{ loading ? 'جاري التحميل...' : 'تطبيق الفلتر' }}
      </button>
      <button class="btn btn-secondary" (click)="clearFilters()">
        مسح الفلاتر
      </button>
      <button class="btn btn-success" (click)="openModal()">
        إضافة منتج جديد
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>جاري تحميل المنتجات...</p>
  </div>

  <!-- Products Section -->
  <div *ngIf="!loading && products.length > 0" class="products-section">
    <div class="table-container">
      <table class="products-table">
        <thead>
          <tr>
            <th>الصورة</th>
            <th (click)="onSortChange('name')" class="sortable">
              اسم المنتج {{ getSortIcon('name') }}
            </th>
            <th>الوصف</th>
            <th (click)="onSortChange('price')" class="sortable">
              السعر {{ getSortIcon('price') }}
            </th>
            <th (click)="onSortChange('stock')" class="sortable">
              المخزون {{ getSortIcon('stock') }}
            </th>
            <th (click)="onSortChange('category')" class="sortable">
              الفئة {{ getSortIcon('category') }}
            </th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of products">
            <td class="product-image">
              <img [src]="product.images && product.images.length > 0 ? 
                          staticFiles + product.images[0].imageUrl : 
                          'assets/images/placeholder.jpg'" 
                   [alt]="product.title">
            </td>
            <td class="product-name">{{ product.title }}</td>
            <td class="product-description">{{ product.description }}</td>
            <td class="product-price">{{ product.price | currency:'KWD':'symbol':'1.1-1' }}</td>
            <td class="product-stock">
              <span [class]="product.stock > 0 ? 'in-stock' : 'out-of-stock'">
                {{ product.stock }}
              </span>
            </td>
            <td class="product-category">{{ product.category?.name || 'غير محدد' }}</td>
            <td class="product-actions">
              <button class="btn btn-sm btn-primary" (click)="editProduct(product)">
                تعديل
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteProduct(product.id)">
                حذف
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-section">
      <div class="pagination-info">
        عرض {{ (currentPage - 1) * pageSize + 1 }} إلى {{ Math.min(currentPage * pageSize, totalItems) }} 
        من أصل {{ totalItems }} منتج
      </div>
      
      <div class="pagination-controls">
        <button class="btn btn-sm" [disabled]="!hasPreviousPage" (click)="onPageChange(currentPage - 1)">
          السابق
        </button>
        
        <div class="page-numbers">
          <button *ngFor="let page of getPageNumbers()" 
                  class="btn btn-sm" 
                  [class.active]="page === currentPage"
                  (click)="onPageChange(page)">
            {{ page }}
          </button>
        </div>
        
        <button class="btn btn-sm" [disabled]="!hasNextPage" (click)="onPageChange(currentPage + 1)">
          التالي
        </button>
      </div>
    </div>
  </div>

  <!-- No Products Message -->
  <div *ngIf="!loading && products.length === 0" class="no-products">
    <p>لا توجد منتجات تطابق معايير البحث</p>
  </div>

  <!-- Product Modal -->
  <div *ngIf="isModalOpen" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ selectedProduct ? 'تعديل المنتج' : 'إضافة منتج جديد' }}</h3>
        <button class="close-btn" (click)="closeModal()">&times;</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
          <div class="form-group">
            <label for="title">اسم المنتج:</label>
            <input type="text" id="title" formControlName="title" class="form-control" 
                   placeholder="اسم المنتج">
          </div>

          <div class="form-group">
            <label for="description">الوصف:</label>
            <textarea id="description" formControlName="description" class="form-control" 
                      placeholder="وصف المنتج" rows="4"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="price">السعر:</label>
              <input type="number" id="price" formControlName="price" class="form-control" 
                     placeholder="0.00" min="0" step="0.01">
            </div>

            <div class="form-group">
              <label for="stock">المخزون:</label>
              <input type="number" id="stock" formControlName="stock" class="form-control" 
                     placeholder="0" min="0">
            </div>
          </div>

          <div class="form-group">
            <label for="categoryId">الفئة:</label>
            <select id="categoryId" formControlName="categoryId" class="form-control">
              <option value="">اختر الفئة</option>
              <option *ngFor="let category of categories" [value]="category.id">
                {{ category.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="images">الصور:</label>
            <input type="file" id="images" (change)="onImageChange($event)" 
                   class="form-control" multiple accept="image/*">
            <div *ngIf="imagePreview" class="image-preview">
              <img [src]="staticFiles+imagePreview" alt="معاينة الصورة">
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="!productForm.valid || loading">
              {{ loading ? 'جاري الحفظ...' : (selectedProduct ? 'تحديث' : 'إضافة') }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="closeModal()">
              إلغاء
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>